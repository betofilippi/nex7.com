name: ğŸ“Š Deployment Status Dashboard

on:
  deployment_status:
  workflow_run:
    workflows: ["ğŸ¤– Auto Deploy Monitor & Fix"]
    types: [completed]

permissions:
  contents: read
  issues: write
  deployments: read

jobs:
  update-status:
    name: Update Deployment Status
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event.deployment_status.state == 'failure'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ‰ Handle Successful Deployment
        if: github.event.deployment_status.state == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = context.payload.deployment_status.target_url;
            const environment = context.payload.deployment_status.environment;
            const sha = context.payload.deployment.sha;
            
            console.log(`âœ… Deployment successful!`);
            console.log(`ğŸŒ URL: ${deploymentUrl}`);
            console.log(`ğŸ·ï¸ Environment: ${environment}`);
            console.log(`ğŸ“ Commit: ${sha}`);
            
            // Close any open deployment failure issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-deploy-failure'
            });
            
            for (const issue of issues.data) {
              if (issue.body && issue.body.includes(sha)) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ğŸ‰ **Deployment Successful!**
                  
The deployment has been completed successfully and is now live.

**ğŸ“Š Deployment Details:**
- **URL:** ${deploymentUrl}
- **Environment:** ${environment}
- **Commit:** ${sha}
- **Status:** âœ… Live and running
- **Time:** ${new Date().toISOString()}

This issue will be closed automatically.

---
*ğŸ¤– Automated by GitHub Actions*`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  labels: [...issue.labels.map(l => l.name), 'resolved', 'deployed']
                });
                
                console.log(`âœ… Closed issue #${issue.number}`);
              }
            }

      - name: ğŸš¨ Handle Failed Deployment
        if: github.event.deployment_status.state == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = context.payload.deployment_status.target_url;
            const environment = context.payload.deployment_status.environment;
            const sha = context.payload.deployment.sha;
            const description = context.payload.deployment_status.description;
            
            console.log(`âŒ Deployment failed!`);
            console.log(`ğŸŒ URL: ${deploymentUrl}`);
            console.log(`ğŸ·ï¸ Environment: ${environment}`);
            console.log(`ğŸ“ Commit: ${sha}`);
            console.log(`ğŸ’¬ Description: ${description}`);
            
            // Check if we already have an issue for this commit
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure'
            });
            
            const commitIssue = existingIssues.data.find(issue => 
              issue.body && issue.body.includes(sha)
            );
            
            if (!commitIssue) {
              const issueBody = `# ğŸš¨ Deployment Failure Alert
              
**Environment:** ${environment}  
**Commit:** ${sha}  
**Time:** ${new Date().toISOString()}  
**Target URL:** ${deploymentUrl}

## ğŸ“‹ Failure Details
${description || 'No description provided'}

## ğŸ” Troubleshooting Steps
1. Check the deployment logs in Vercel dashboard
2. Review the commit changes for potential issues
3. Run \`npm run build\` locally to test
4. Check for missing environment variables
5. Verify all dependencies are properly installed

## ğŸ¯ Quick Actions
- [ ] Check Vercel deployment logs
- [ ] Test build locally
- [ ] Review environment variables
- [ ] Check for dependency issues
- [ ] Manual deployment test

## ğŸ”— Links
- **Vercel Dashboard:** ${deploymentUrl}
- **Commit:** https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${sha}

---
*ğŸ¤– Auto-generated by GitHub Actions*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ Deployment Failed: ${sha.substring(0, 8)} - ${environment}`,
                body: issueBody,
                labels: ['deployment-failure', 'bug', 'urgent']
              });
              
              console.log('âœ… Created deployment failure issue');
            } else {
              console.log('â„¹ï¸ Issue already exists for this deployment');
            }