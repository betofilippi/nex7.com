name: ğŸ¤– Auto Deploy Monitor & Fix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  monitor-deploy:
    name: Monitor Vercel Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm
            pnpm install
          else
            npm ci
          fi

      - name: ğŸ” Run preventive code analysis
        id: analysis
        run: |
          echo "ğŸ” Running preventive code analysis..."
          
          # Run our custom analysis script
          if npm run analyze 2>&1 | tee analysis.log; then
            echo "âœ… Code analysis passed"
          else
            echo "âš ï¸ Code analysis found issues, attempting auto-fix..."
            echo "analysis_warning=true" >> $GITHUB_OUTPUT
            
            # Try auto-fix
            if npm run analyze:fix 2>&1 | tee analysis-fix.log; then
              echo "ğŸ”§ Auto-fixes applied successfully"
              echo "analysis_fixed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Auto-fix failed"
              echo "analysis_error=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ§ª Run pre-deploy checks
        id: pre-checks
        run: |
          echo "Running pre-deployment checks..."
          
          # Type check
          if npm run type-check 2>&1 | tee type-check.log; then
            echo "âœ… TypeScript check passed"
          else
            echo "âŒ TypeScript check failed"
            echo "typescript_error=true" >> $GITHUB_OUTPUT
          fi
          
          # Lint check (allow warnings, fail on errors)
          if npm run lint -- --max-warnings 20 2>&1 | tee lint.log; then
            echo "âœ… ESLint check passed"
          else
            echo "âŒ ESLint check failed"
            echo "lint_error=true" >> $GITHUB_OUTPUT
          fi
          
          # Build check
          if npm run build 2>&1 | tee build.log; then
            echo "âœ… Build check passed"
          else
            echo "âŒ Build check failed"
            echo "build_error=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commit preventive analysis fixes
        if: steps.analysis.outputs.analysis_fixed == 'true'
        run: |
          echo "ğŸ’¾ Committing preventive analysis fixes..."
          git config --local user.email "action@github.com"
          git config --local user.name "NEX7 Auto-Analysis Bot"
          git add .
          git commit -m "ğŸ¤– Auto-fix: Preventive code analysis fixes

ğŸ” Applied fixes from preventive analysis:
- Unused variable prefixes
- Type safety improvements  
- React hooks optimization
- ESLint compliance

ğŸš€ Generated by NEX7 Analysis System
âš¡ Commit: ${{ github.sha }}"
          git push

      - name: ğŸ”¨ Auto-fix deployment issues
        if: steps.pre-checks.outputs.typescript_error == 'true' || steps.pre-checks.outputs.lint_error == 'true' || steps.pre-checks.outputs.build_error == 'true'
        run: |
          echo "ğŸ”§ Attempting to fix deployment issues..."
          
          # Run auto-fix script if it exists
          if [ -f "scripts/auto-fix-errors.sh" ]; then
            chmod +x scripts/auto-fix-errors.sh
            ./scripts/auto-fix-errors.sh
          fi
          
          # Try ESLint auto-fix
          npm run lint:fix || echo "ESLint auto-fix completed"
          
          # Check if fixes were applied
          if git diff --quiet; then
            echo "No changes made during auto-fix"
          else
            echo "Changes detected, committing fixes..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Auto-Fix"
            git add .
            git commit -m "ğŸ¤– Auto-fix: Deployment error resolution

ğŸ”§ Applied automatic fixes:
- TypeScript error suppressions
- ESLint auto-fixes
- Import path corrections
- Dependency updates

ğŸš€ Generated by GitHub Actions
âš¡ Commit: ${{ github.sha }}"
            git push
          fi

      - name: â±ï¸ Wait for Vercel deployment
        id: wait-deploy
        run: |
          echo "ğŸ• Waiting for Vercel deployment to start..."
          sleep 30
          
          # Get deployment using Vercel API
          node scripts/monitor-vercel-deployment.js
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}

      - name: ğŸš¨ Create issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read error logs
            let errorDetails = '';
            try {
              if (fs.existsSync('type-check.log')) {
                errorDetails += '## TypeScript Errors\n```\n' + fs.readFileSync('type-check.log', 'utf8') + '\n```\n\n';
              }
              if (fs.existsSync('lint.log')) {
                errorDetails += '## ESLint Errors\n```\n' + fs.readFileSync('lint.log', 'utf8') + '\n```\n\n';
              }
              if (fs.existsSync('build.log')) {
                errorDetails += '## Build Errors\n```\n' + fs.readFileSync('build.log', 'utf8') + '\n```\n\n';
              }
              if (fs.existsSync('vercel-deploy.log')) {
                errorDetails += '## Vercel Deployment Errors\n```\n' + fs.readFileSync('vercel-deploy.log', 'utf8') + '\n```\n\n';
              }
            } catch (e) {
              errorDetails = 'Error reading log files: ' + e.message;
            }
            
            const issueBody = `
            # ğŸš¨ Automatic Deployment Failure Alert
            
            **Commit:** ${context.sha}
            **Branch:** ${context.ref}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            ## ğŸ“Š Deployment Status
            âŒ **Deployment Failed** - Automatic fixes were unable to resolve the issues.
            
            ## ğŸ” Error Details
            ${errorDetails}
            
            ## ğŸ› ï¸ Attempted Fixes
            - âœ… TypeScript error suppression (@ts-ignore)
            - âœ… ESLint auto-fix (--fix)
            - âœ… Import path corrections
            - âœ… Dependency installation
            
            ## ğŸ¯ Next Steps
            1. Review the error logs above
            2. Apply manual fixes for complex issues
            3. Test locally before pushing
            4. Re-run deployment
            
            ## ğŸ¤– Auto-Generated
            This issue was created automatically by GitHub Actions.
            
            **Time:** ${new Date().toISOString()}
            **Workflow File:** \`.github/workflows/auto-deploy-monitor.yml\`
            `;
            
            // Check if issue already exists for this commit
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-deploy-failure',
              per_page: 100
            });
            
            const commitIssue = existingIssues.data.find(issue => 
              issue.body && issue.body.includes(context.sha)
            );
            
            if (!commitIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ Deploy Failed: ${context.sha.substring(0, 8)} - Auto-fix unsuccessful`,
                body: issueBody,
                labels: ['auto-deploy-failure', 'bug', 'deployment']
              });
              
              console.log('âœ… Created deployment failure issue');
            } else {
              console.log('â„¹ï¸ Issue already exists for this commit');
            }

      - name: ğŸ‰ Close resolved issues
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // Close any open deployment failure issues for this commit
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-deploy-failure'
            });
            
            for (const issue of issues.data) {
              if (issue.body && issue.body.includes(context.sha)) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `âœ… **Deployment Successful!**
                  
The deployment issue has been automatically resolved.

**Commit:** ${context.sha}
**Status:** âœ… Deployed successfully
**Time:** ${new Date().toISOString()}

Closing this issue automatically.`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  labels: [...issue.labels.map(l => l.name), 'resolved']
                });
              }
            }

      - name: ğŸ“Š Update deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment monitoring completed successfully"
          else
            echo "âŒ Deployment monitoring failed"
          fi